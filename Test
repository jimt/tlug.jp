#!/usr/bin/env bash
set -e -o pipefail
trap 'echo 1>&2 FAILED.; exit 1;' 0

basedir=$(cd "$(dirname "$0")" && pwd -P)
cd "$basedir"

#   Netlify caches neither ~/.stack/ which contains our downloaded GCC
#   and builds of downloaded packages, nor .stack-work, which contains
#   the build of this project. Since a full build takes more than the
#   half-hour build time limit of the Netlify robot, we need to move
#   these to some place that will be saved when we're building on
#   Netlify. (We don't want to do this otherwise.)
#
if [[ $HOME = /opt/buildhome && -n $NETLIFY_IMAGES_CDN_DOMAIN ]]; then
    echo ===== Linking cache dirs for Netlify
    mkdir -p node_modules/stack node_modules/stack-work
    ln -s "$basedir/node_modules/stack/" ~/.stack
    ln -s node_modules/stack-work/ .stack-work
fi

echo ========== HOME=$HOME
ls -al ~
echo ========== cwd=$(/bin/pwd -P).
ls -al
echo ========== ENV
env
echo ==========
sleep 5     # Allow Netlify to finish logging
exit 99

mkdir -p ~/.local/bin/
export PATH=~/.local/bin:$PATH
stack --version \
    || curl -sSL https://get.haskellstack.org/ | sh -s - -d ~/.local/bin

stack upgrade
stack build
stack exec site build 

trap '' 0
